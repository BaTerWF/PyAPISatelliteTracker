<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satellite Orbits with Three.js</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #satelliteTableModal {
            display: none;
            position: fixed;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            background: white;
            border: 1px solid black;
            overflow: auto;
            z-index: 1000;
        }
        #loadingIndicator {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        #loadingIndicator span {
            display: block;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loadingIndicator div {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <button id="showTableBtn">Показать таблицу</button>

    <div id="satelliteTableModal">
        <div style="padding: 10px;">
            <button id="closeTableBtn">Закрыть</button>
            <button id="refreshTableBtn">Обновить данные</button>
            <input type="text" id="searchInput" placeholder="Поиск..." style="margin-left: 20px; padding: 5px; width: 300px;">
        </div>
        <table border="1" id="satelliteTable" style="width: 100%; text-align: left;">
            <thead>
                <tr>
                    <th>Выбрать</th>
                    <th>Название спутника</th>
                    <th>Line 1</th>
                    <th>Line 2</th>
                    <th>NORAD ID</th>
                    <th>Дата обновления</th>
                    <th>Следуемый</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="loadingIndicator">
        <span>Загрузка данных...</span>
        <div></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script>
        const selectedNoradIds = new Set();

        // Показать/скрыть индикатор загрузки
        function toggleLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        // Загрузка данных в таблицу
        async function loadSatelliteData() {
            const tableBody = document.querySelector('#satelliteTable tbody');
            tableBody.innerHTML = '';
            try {
                const response = await fetch('/get_all_satelite'); // Убедитесь, что эндпоинт корректный
                if (!response.ok) throw new Error('Ошибка загрузки данных');
                const satellites = await response.json();
                satellites.forEach(satellite => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="checkbox" class="satellite-checkbox" data-norad-id="${satellite.norad_id}"></td>
                        <td>${satellite.satellite_name}</td>
                        <td>${satellite.line1}</td>
                        <td>${satellite.line2}</td>
                        <td>${satellite.norad_id}</td>
                        <td>${satellite.timestamp}</td>
                        <td>${satellite.Tracker ? 'Да' : 'Нет'}</td>
                    `;
                    tableBody.appendChild(row);
                });

                document.querySelectorAll('.satellite-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', event => {
                        const noradId = event.target.dataset.noradId;
                        event.target.checked ? selectedNoradIds.add(noradId) : selectedNoradIds.delete(noradId);
                        console.log([...selectedNoradIds]);
                    });
                });
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        // Фильтрация таблицы
        function filterTable() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const tableRows = document.querySelectorAll('#satelliteTable tbody tr');
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowText = Array.from(cells).map(cell => cell.textContent.toLowerCase()).join(' ');
                row.style.display = rowText.includes(searchInput) ? '' : 'none';
            });
        }

        // Обработчики кнопок
        document.getElementById('showTableBtn').addEventListener('click', async () => {
            document.getElementById('satelliteTableModal').style.display = 'block';
            toggleLoading(true);
            await loadSatelliteData();
            toggleLoading(false);
        });

        document.getElementById('closeTableBtn').addEventListener('click', () => {
            document.getElementById('satelliteTableModal').style.display = 'none';
            sendNoradIds()
        });

        document.getElementById('refreshTableBtn').addEventListener('click', async () => {
            toggleLoading(true);
            try {
                const response = await fetch('/fetch_tle', { method: 'GET' }); // Убедитесь, что эндпоинт корректный
                if (!response.ok) throw new Error('Ошибка обновления данных');
                await loadSatelliteData();
            } catch (error) {
                alert('Ошибка: ' + error.message);
            } finally {
                toggleLoading(false);
            }
        });

        // Фильтрация на основе поиска
        document.getElementById('searchInput').addEventListener('input', filterTable);

        // Инициализация Three.js
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);

        // Глобус
        const greenMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        const globeGeometry = new THREE.SphereGeometry(1, 64, 64);  // Радиус глобуса 1
        const globe = new THREE.Mesh(globeGeometry, greenMaterial);
        scene.add(globe);

        // Освещение
        const light = new THREE.PointLight(0xffffff, 1);
        light.position.set(5, 5, 5);
        scene.add(light);

        camera.position.set(3, 3, 3);
        controls.update();

        function animate() {
            requestAnimationFrame(animate);
            globe.rotation.y += 0.001;
            renderer.render(scene, camera);
        }

        animate();

        // Функция для отправки NORAD ID на сервер
        async function sendNoradIds() {
            if (selectedNoradIds.size === 0) {
                alert('Выберите хотя бы один спутник');
                return;
            }

            await displayOrbitData([...selectedNoradIds]);
        }

        async function displayOrbitData(noradIds) {
            try {
                const response = await fetch(`/get_orbit_data?norad_ids=${noradIds.join('&norad_ids=')}`);
                if (!response.ok) throw new Error('Ошибка загрузки данных орбиты');

                const satelliteData = await response.json();

                // Обновляем позиции спутников
                satelliteData.satellites.forEach(satellite => {
                    updateSatellitePosition(satellite);
                    createOrbitFromData(satellite);
                });
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        // Функция для регулярного обновления данных орбит спутников
        function fetchOrbitDataRegularly(noradIds) {
            setInterval(async () => {
                await displayOrbitData(noradIds);
            }, 5000); // Период 5000 миллисекунд (5 секунд)
        }

        function createOrbitFromData(satellite) {
            const { semi_major_axis_km, eccentricity, inclination_deg, right_ascension_deg, argument_perigee_deg } = satellite.orbit_data.orbital_parameters;

            const scaleFactor = 0.001; // Масштабируем орбиту, уменьшаем радиус
            const semiMajorAxis = semi_major_axis_km * scaleFactor;
            const inclination = THREE.MathUtils.degToRad(inclination_deg);
            const rightAscension = THREE.MathUtils.degToRad(right_ascension_deg);
            const argumentPerigee = THREE.MathUtils.degToRad(argument_perigee_deg);

            const points = []; // Точки для траектории орбиты
            const numPoints = 360; // Количество точек для траектории

            for (let i = 0; i <= numPoints; i++) {
                const trueAnomaly = THREE.MathUtils.degToRad((i / numPoints) * 360); // Истинная аномалия
                const radius = semiMajorAxis * (1 - Math.pow(eccentricity, 2)) / (1 + eccentricity * Math.cos(trueAnomaly));

                // Вычисляем положение в орбитальной плоскости
                const xOrbital = radius * Math.cos(trueAnomaly);
                const yOrbital = radius * Math.sin(trueAnomaly);

                // Применяем вращение для преобразования в глобальные координаты
                const xRotated = xOrbital * Math.cos(argumentPerigee) - yOrbital * Math.sin(argumentPerigee);
                const yRotated = xOrbital * Math.sin(argumentPerigee) + yOrbital * Math.cos(argumentPerigee);

                const z = yRotated * Math.sin(inclination);
                const xFinal = xRotated * Math.cos(rightAscension) - z * Math.sin(rightAscension);
                const yFinal = xRotated * Math.sin(rightAscension) + z * Math.cos(rightAscension);
                const zFinal = yRotated * Math.cos(inclination);

                points.push(new THREE.Vector3(xFinal, yFinal, zFinal));
            }

            // Создаем геометрию линии для орбиты
            const orbitGeometry = new THREE.BufferGeometry().setFromPoints(points);

            // Создаем материал для линии
            const orbitMaterial = new THREE.LineBasicMaterial({ color: 0xff0000 });

            // Создаем объект линии и добавляем его в сцену
            const orbitLine = new THREE.Line(orbitGeometry, orbitMaterial);
            scene.add(orbitLine);
        }


        function solveKeplerEquation(meanAnomaly, eccentricity, tolerance = 1e-6) {
            let E = meanAnomaly;
            let delta = 1;

            while (delta > tolerance) {
                const nextE = E - (E - eccentricity * Math.sin(E) - meanAnomaly) / (1 - eccentricity * Math.cos(E));
                delta = Math.abs(nextE - E);
                E = nextE;
            }

            return E;
        }
        function convertLatLonAltToXYZ(latitude_deg, longitude_deg, altitude_km) {
            const R = 6371; // Радиус Земли в километрах

            // Преобразуем градусы в радианы
            const lat = THREE.MathUtils.degToRad(latitude_deg);
            const lon = THREE.MathUtils.degToRad(longitude_deg);

            // Расчет радиуса от центра Земли (с учетом высоты спутника)
            const radius = R + altitude_km;

            // Вычисление 3D-координат
            const x = radius * Math.cos(lat) * Math.cos(lon);
            const y = radius * Math.cos(lat) * Math.sin(lon);
            const z = radius * Math.sin(lat);

            return { x, y, z };
        }

        function updateSatellitePosition(satelliteData) {
            const { norad_id, orbit_data } = satelliteData;

            // Проверяем, есть ли данные о географической позиции
            if (!orbit_data || !orbit_data.current_lat_lon_alt) {
                console.error(`Нет данных о позиции для спутника NORAD ID: ${norad_id}`);
                return;
            }

            const position = orbit_data.current_lat_lon_alt;

            // Проверяем наличие координат
            if (position.latitude_deg === undefined || position.longitude_deg === undefined || position.altitude_km === undefined) {
                console.error(`Некорректные данные о позиции для спутника NORAD ID: ${norad_id}`);
                return;
            }

            // Преобразуем данные в 3D-координаты
            const satellitePosition = convertLatLonAltToXYZ(position.latitude_deg, position.longitude_deg, position.altitude_km);

            // Логируем координаты для диагностики
            console.log(`Положение спутника NORAD ID: ${norad_id} - X: ${satellitePosition.x}, Y: ${satellitePosition.y}, Z: ${satellitePosition.z}`);

            // Масштабируем координаты для отображения
            const scaleFactor = 0.001;

            // Создаем объект для спутника
            const satelliteRadius = 0.05; // Радиус спутника
            const satelliteMaterial = new THREE.MeshBasicMaterial({ color: 0x0000ff });
            const satelliteGeometry = new THREE.SphereGeometry(satelliteRadius, 8, 8);
            const satelliteMesh = new THREE.Mesh(satelliteGeometry, satelliteMaterial);

            // Устанавливаем позицию спутника с применением масштаба
            satelliteMesh.position.set(satellitePosition.x * scaleFactor, satellitePosition.y * scaleFactor, satellitePosition.z * scaleFactor);

            // Добавляем спутник в сцену
            scene.add(satelliteMesh);
        }
    </script>
</body>
</html>
